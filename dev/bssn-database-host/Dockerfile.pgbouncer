# Use the official PostgreSQL image as the base image
FROM postgres:latest

# Install pgbouncer
RUN apt-get update && apt-get install -y pgbouncer

# Create a non-root user for running pgbouncer
RUN groupadd -r pgbouncer && useradd -r -g pgbouncer pgbouncer

# Copy the pgbouncer configuration file
COPY ./config/pgbouncer.ini /etc/pgbouncer/pgbouncer.ini

# Copy the userlist file for authentication
COPY ./config/userlist.txt /etc/pgbouncer/userlist.txt

# Create a log directory for pgbouncer
RUN mkdir -p /var/log/pgbouncer && \
    chown pgbouncer:pgbouncer /var/log/pgbouncer && \
    chmod 755 /var/log/pgbouncer

# Set the ownership and permissions for configuration files
RUN chown pgbouncer:pgbouncer /etc/pgbouncer/pgbouncer.ini /etc/pgbouncer/userlist.txt && \
    chmod 644 /etc/pgbouncer/pgbouncer.ini /etc/pgbouncer/userlist.txt

# Switch to the non-root user before starting pgbouncer
USER pgbouncer

# Start pgbouncer using the configuration file
CMD ["pgbouncer", "/etc/pgbouncer/pgbouncer.ini"]
